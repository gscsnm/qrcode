<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>批量图书扫码（手动摄像头选择）</title>

<!-- html5-qrcode（首选） -->
<script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
<!-- zxing 备用 -->
<script src="https://unpkg.com/@zxing/browser@latest"></script>

<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;padding:14px;color:#111}
  h1{font-size:1.05rem;margin-bottom:6px}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
  .btn{padding:8px 12px;border-radius:6px;border:1px solid #ccc;background:#f7f7f7;cursor:pointer}
  .btn.primary{background:#0b84ff;color:#fff;border-color:#0b84ff}
  #video, #reader {width:100%;max-width:480px;background:#000;margin:0 auto;border-radius:6px}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{border:1px solid #eee;padding:8px;font-size:0.9rem;text-align:left}
  .small{font-size:0.85rem;color:#666}
  .status{margin-top:8px;color:#0b84ff}
  .err{color:#c00}
  /* Modal */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;z-index:9999}
  .modal{background:#fff;padding:14px;border-radius:8px;max-width:90%;width:420px;box-shadow:0 6px 18px rgba(0,0,0,0.2)}
  .modal h3{margin:0 0 8px 0;font-size:1rem}
  .modal p{margin:8px 0;font-size:0.95rem}
  .modal .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
  .pill{padding:6px 8px;border-radius:999px;border:1px solid #ddd;background:#fafafa}
  .camera-row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
  select, input{padding:8px}
</style>
</head>
<body>
  <h1>📚 批量扫码并计数（手动摄像头选择）</h1>
  <div class="small">通过 HTTPS 打开（GitHub Pages / Netlify），并允许摄像头权限。先刷新相机，再选择你想用的摄像头。</div>

  <div class="controls" style="margin-top:8px">
    <div class="camera-row">
      <button id="refreshCams" class="btn">刷新相机</button>
      <select id="cameraSelect" style="min-width:220px"><option value="">（尚未选择）</option></select>
    </div>

    <button id="startBtn" class="btn primary">开始扫码</button>
    <button id="stopBtn" class="btn">停止扫码</button>
    <button id="undoBtn" class="btn">撤销上一次</button>
    <button id="clearBtn" class="btn">清空全部</button>
    <label class="pill"><input id="dupAllow" type="checkbox" checked> 允许快速重复计数</label>
    <label class="pill"><input id="autoFetch" type="checkbox" checked> 自动抓 OpenLibrary</label>
  </div>

  <div style="max-width:480px;margin:0 auto">
    <div id="reader"></div>
    <video id="video" autoplay playsinline style="display:none;width:100%;"></video>
  </div>

  <div class="status" id="status">状态：空闲</div>
  <div id="error" class="err"></div>

  <div style="margin-top:12px;max-width:680px">
    <div style="display:flex;gap:8px">
      <input id="manualInput" placeholder="手动条码或 ISBN，回车添加" style="flex:1;padding:8px"/>
      <button id="manualAdd" class="btn">添加</button>
    </div>
    <div class="small" style="margin-top:6px">误触可用撤销/减计数/删除操作。</div>
  </div>

  <table id="tb" style="margin-top:14px;max-width:960px">
    <thead><tr><th>#</th><th>条码</th><th>数量</th><th>首次扫描</th><th>最近扫描（与书名/作者）</th><th>操作</th></tr></thead>
    <tbody></tbody>
  </table>

  <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
    <button id="exportCsv" class="btn">导出汇总 CSV</button>
    <button id="exportEvents" class="btn">导出事件 CSV（每次扫码）</button>
    <button id="downloadTxt" class="btn">下载条码 TXT（barcode,count）</button>
  </div>

  <!-- Modal DOM（默认隐藏） -->
  <div id="modalRoot" style="display:none"></div>

<script>
/* state */
const counts = new Map();
const events = [];
const lastScanAt = new Map();
const pendingConfirm = new Set();
const DEBOUNCE_MS = 700;

let allowQuickDup = true;
let scanning = false;
let html5Qr = null;
let zxingReader = null;

const statusEl = document.getElementById('status');
const errorEl = document.getElementById('error');
const readerDiv = document.getElementById('reader');
const videoElem = document.getElementById('video');
const tbody = document.querySelector('#tb tbody');
const cameraSelect = document.getElementById('cameraSelect');

document.getElementById('refreshCams').addEventListener('click', refreshCameras);
document.getElementById('startBtn').addEventListener('click', startScanner);
document.getElementById('stopBtn').addEventListener('click', stopScanner);
document.getElementById('undoBtn').addEventListener('click', undoLast);
document.getElementById('clearBtn').addEventListener('click', clearAll);
document.getElementById('manualAdd').addEventListener('click', ()=>{ const v=document.getElementById('manualInput').value.trim(); if(v){ handleScanned(v); document.getElementById('manualInput').value=''; }});
document.getElementById('manualInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ document.getElementById('manualAdd').click(); }});
document.getElementById('exportCsv').addEventListener('click', downloadSummaryCSV);
document.getElementById('exportEvents').addEventListener('click', downloadEventsCSV);
document.getElementById('downloadTxt').addEventListener('click', downloadTxtFile);
document.getElementById('dupAllow').addEventListener('change', (e)=>{ allowQuickDup = e.target.checked; });

function setStatus(s){ statusEl.textContent = '状态：' + s; errorEl.textContent=''; }
function setError(e){ errorEl.textContent = '错误：' + e; statusEl.textContent = '状态：错误'; }

function nowISO(){ return new Date().toISOString(); }

/* 非阻塞确认 modal */
function showConfirmAsync(title, message){
  return new Promise(resolve => {
    const root = document.getElementById('modalRoot');
    root.innerHTML = '';
    const backdrop = document.createElement('div');
    backdrop.className = 'modal-backdrop';
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `<h3>${escapeHtml(title)}</h3><p>${escapeHtml(message)}</p>`;
    const actions = document.createElement('div');
    actions.className = 'actions';
    const btnCancel = document.createElement('button');
    btnCancel.className = 'btn'; btnCancel.textContent = '取消';
    const btnOk = document.createElement('button');
    btnOk.className = 'btn primary'; btnOk.textContent = '确定';
    actions.appendChild(btnCancel); actions.appendChild(btnOk);
    modal.appendChild(actions);
    backdrop.appendChild(modal);
    root.appendChild(backdrop);
    root.style.display = 'block';
    btnOk.onclick = ()=>{ root.innerHTML=''; root.style.display='none'; resolve(true); };
    btnCancel.onclick = ()=>{ root.innerHTML=''; root.style.display='none'; resolve(false); };
    backdrop.onclick = (ev)=>{ if(ev.target === backdrop){ root.innerHTML=''; root.style.display='none'; resolve(false);} };
  });
}

/* handle scanned */
async function handleScanned(raw){
  const code = String(raw).replace(/\s+/g,'');
  const t = Date.now();
  const last = lastScanAt.get(code) || 0;
  if(!allowQuickDup && t - last < DEBOUNCE_MS) return;
  lastScanAt.set(code, t);

  if(counts.has(code)){
    if(pendingConfirm.has(code)) return;
    pendingConfirm.add(code);
    const rec = counts.get(code);
    const titlePreview = rec && rec.title ? `（已记录: ${rec.title}）` : '';
    try{
      const ok = await showConfirmAsync('重复条码', `检测到重复条码：${code} ${titlePreview}\n是否把数量 +1？`);
      pendingConfirm.delete(code);
      if(ok){
        rec.count += 1; rec.last = nowISO(); events.push({barcode: code, time: nowISO()}); renderTable();
      } else {
        // canceled
      }
    } catch(e){
      pendingConfirm.delete(code);
    }
    return;
  }

  // add new
  counts.set(code, { count: 1, first: nowISO(), last: nowISO() });
  events.push({ barcode: code, time: nowISO() });
  renderTable();

  if(document.getElementById('autoFetch').checked){
    const isIsbn = /^\d{10}$|^\d{13}$/.test(code.replace(/[^0-9Xx]/g,''));
    if(isIsbn){
      fetch(`https://openlibrary.org/api/books?bibkeys=ISBN:${code}&format=json&jscmd=data`)
        .then(r=>r.json())
        .then(js=>{
          const key = `ISBN:${code}`;
          if(js && js[key]){
            const info = js[key];
            const rec = counts.get(code);
            if(rec){ rec.title = info.title || ''; rec.authors = (info.authors||[]).map(a=>a.name).join(', '); renderTable(); }
          }
        }).catch(()=>{});
    }
  }
}

/* render */
function renderTable(){
  tbody.innerHTML = '';
  let i=0;
  for(const [barcode, rec] of counts.entries()){
    i++;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${i}</td>
      <td>${escapeHtml(barcode)}</td>
      <td>
        <button data-action="dec" data-code="${barcode}" class="btn">-</button>
        <span style="margin:0 8px">${rec.count}</span>
        <button data-action="inc" data-code="${barcode}" class="btn">+</button>
      </td>
      <td>${rec.first||''}</td>
      <td>${rec.last||''}${rec.title?'<div class="small">《'+escapeHtml(rec.title)+'》</div>':''}</td>
      <td><button data-action="remove" data-code="${barcode}" class="btn">删除</button></td>
    `;
    tbody.appendChild(tr);
  }
  tbody.querySelectorAll('button[data-action]').forEach(b=>{
    b.onclick = ()=> {
      const a = b.dataset.action, c = b.dataset.code;
      if(a==='inc'){ changeCount(c,1); }
      else if(a==='dec'){ changeCount(c,-1); }
      else if(a==='remove'){ counts.delete(c); renderTable(); }
    };
  });
}

function changeCount(code,delta){
  const rec = counts.get(code);
  if(!rec) return;
  rec.count += delta;
  if(rec.count <= 0) counts.delete(code);
  else rec.last = nowISO();
  if(delta>0) events.push({barcode: code, time: nowISO()});
  renderTable();
}

function undoLast(){
  const ev = events.pop();
  if(!ev){ alert('没有可撤销的扫码'); return; }
  const rec = counts.get(ev.barcode);
  if(rec){
    rec.count -= 1;
    if(rec.count <= 0) counts.delete(ev.barcode);
    else rec.last = nowISO();
  }
  renderTable();
}

function clearAll(){
  if(!confirm('确定清空所有记录吗？')) return;
  counts.clear(); events.length = 0; renderTable();
}

/* exports */
function downloadSummaryCSV(){
  const header = ['barcode','count','first_seen','last_seen'];
  let csv = header.join(',') + '\n';
  for(const [b, r] of counts.entries()){
    csv += [b, r.count, r.first||'', r.last||''].map(csvEscape).join(',') + '\n';
  }
  downloadBlob(csv, `books_summary_${(new Date()).toISOString().slice(0,10)}.csv`, 'text/csv;charset=utf-8;');
}
function downloadEventsCSV(){
  const header = ['barcode','time'];
  let csv = header.join(',') + '\n';
  events.forEach(e=>{ csv += [e.barcode, e.time].map(csvEscape).join(',') + '\n'; });
  downloadBlob(csv, `books_events_${(new Date()).toISOString().slice(0,10)}.csv`, 'text/csv;charset=utf-8;');
}
function downloadTxtFile(){
  let txt = '';
  for(const [b, r] of counts.entries()) txt += `${b},${r.count}\n`;
  downloadBlob(txt, `books_${(new Date()).toISOString().slice(0,10)}.txt`, 'text/plain');
}
function csvEscape(v){ if(v==null) return '""'; const s = String(v).replaceAll('"','""'); return `"${s}"`; }
function downloadBlob(content, filename, type){
  const blob = new Blob([content], { type }); const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}
function escapeHtml(s){ if(!s) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;'); }

/* ==== 摄像头列表刷新（手动） ==== */
async function refreshCameras(){
  setError('');
  setStatus('请求摄像头权限并刷新列表...');
  try {
    // 请求权限 briefly to make labels available
    const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
    // immediately stop tracks (we only needed permission/labels)
    stream.getTracks().forEach(t => t.stop());
  } catch(e){
    // permission denied or other; still try enumerateDevices (labels may be empty)
    console.warn('getUserMedia failed or denied:', e);
  }
  try{
    const devices = await navigator.mediaDevices.enumerateDevices();
    const cams = devices.filter(d => d.kind === 'videoinput');
    cameraSelect.innerHTML = '';
    if(!cams.length){ cameraSelect.appendChild(new Option('无摄像头','')); setStatus('未检测到摄像头'); return; }
    cameraSelect.appendChild(new Option('（请选择）',''));
    cams.forEach(c=>{
      const label = c.label || c.deviceId;
      const opt = new Option(label, c.deviceId);
      cameraSelect.appendChild(opt);
    });
    setStatus('已刷新相机列表');
  }catch(e){
    setError('刷新摄像头列表失败：' + (e && e.message ? e.message : e));
  }
}

/* 启动扫描：使用用户在下拉中选择的 deviceId（首选 html5-qrcode，其次 ZXing） */
async function startScanner(){
  if(scanning){ setStatus('已在扫描中'); return; }
  setError('');
  const selectedId = cameraSelect.value || null;
  if(!selectedId){
    if(!confirm('未选择具体摄像头，是否继续使用默认摄像头？（推荐先点击“刷新相机”并选择后置主摄）')){}
  }
  setStatus('尝试启动摄像头（html5-qrcode 首选）...');
  // stop any previous
  stopScanner();

  // try html5-qrcode
  try {
    if(typeof Html5Qrcode === 'undefined') throw new Error('Html5Qrcode 未加载');
    const cams = await Html5Qrcode.getCameras(); // may return cameras with id,label
    let camId = selectedId || (cams && cams.length ? cams[0].id : null);
    if(!camId && cams && cams.length) camId = cams[0].id;
    if(!camId) throw new Error('未找到可用摄像头');
    html5Qr = new Html5Qrcode("reader");
    await html5Qr.start(camId, { fps: 10, qrbox: 250 },
      (decodedText) => { handleScanned(decodedText); },
      (err) => { /* per-frame errors ignored */ }
    );
    scanning = true;
    setStatus('使用 html5-qrcode 扫描中');
    return;
  } catch(e){
    console.warn('html5-qrcode 启动失败：', e);
    setStatus('html5-qrcode 启动失败，尝试 ZXing...');
  }

  // fallback ZXing
  try {
    if(!window.ZXing && !window.ZXingBrowser) throw new Error('ZXing 未加载');
    const codeReader = new ZXing.BrowserMultiFormatReader();
    zxingReader = codeReader;
    // list devices via ZXing (or navigator enumerateDevices)
    const devices = await ZXing.BrowserCodeReader.listVideoInputDevices();
    const cams = devices.map(d => ({ deviceId: d.deviceId, label: d.label || d.deviceId }));
    const deviceId = selectedId || (cams.length ? cams[0].deviceId : undefined);
    if(!deviceId) throw new Error('未找到可用摄像头（ZXing）');
    document.getElementById('video').style.display = '';
    codeReader.decodeFromVideoDevice(deviceId, 'video', (result, err) => {
      if(result && result.getText) handleScanned(result.getText());
    });
    scanning = true;
    setStatus('使用 ZXing 扫描中');
    return;
  } catch(e2){
    console.error('ZXing 启动失败：', e2);
    setError('摄像头初始化失败，请确认页面为 HTTPS 并允许摄像头权限；或尝试刷新相机并选择其他设备。错误：' + (e2 && e2.message ? e2.message : e2));
    scanning = false;
    return;
  }
}

function stopScanner(){
  if(html5Qr){
    html5Qr.stop().catch(()=>{}); html5Qr = null;
  }
  if(zxingReader){
    try{ zxingReader.reset(); }catch(e){} zxingReader = null;
  }
  document.getElementById('video').style.display = 'none';
  setStatus('已停止');
  scanning = false;
}
window.addEventListener('beforeunload', ()=>{ try{ stopScanner(); }catch(e){} });

</script>
</body>
</html>
