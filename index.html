<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>图书批量扫码</title>
  <script src="https://unpkg.com/@zxing/library@latest"></script>
  <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 20px; }
    video, #reader { width: 100%; max-width: 400px; margin: auto; }
    ul { text-align: left; max-width: 400px; margin: 20px auto; padding: 0; list-style: none; }
    li { padding: 5px; border-bottom: 1px solid #ddd; }
    button { margin: 10px; padding: 10px 20px; }
  </style>
</head>
<body>
  <h1>📚 批量扫码图书条码</h1>
  <div id="zxing-view">
    <video id="video" autoplay></video>
  </div>
  <div id="reader" style="display:none;"></div>

  <h2>已扫描结果</h2>
  <ul id="results"></ul>

  <button onclick="downloadCSV()">下载 CSV</button>
  <button onclick="downloadTXT()">下载 TXT</button>

  <script>
    let scannedCodes = new Set();

    function addResult(code) {
      if (!scannedCodes.has(code)) {
        scannedCodes.add(code);
        const li = document.createElement('li');
        li.textContent = code;
        document.getElementById('results').appendChild(li);
      }
    }

    function downloadCSV() {
      const data = Array.from(scannedCodes).map(c => `"${c}"`).join("\n");
      downloadFile(data, "scanned_books.csv", "text/csv");
    }

    function downloadTXT() {
      const data = Array.from(scannedCodes).join("\n");
      downloadFile(data, "scanned_books.txt", "text/plain");
    }

    function downloadFile(content, filename, type) {
      const blob = new Blob([content], { type });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    async function startZXing() {
      try {
        const codeReader = new ZXing.BrowserMultiFormatReader();
        const videoInputDevices = await codeReader.listVideoInputDevices();
        const selectedDeviceId = videoInputDevices[0]?.deviceId;
        await codeReader.decodeFromVideoDevice(selectedDeviceId, 'video', (result, err) => {
          if (result) {
            addResult(result.getText());
          }
        });
        console.log("ZXing 启动成功");
      } catch (e) {
        console.warn("ZXing 失败，切换到 html5-qrcode:", e);
        document.getElementById('zxing-view').style.display = 'none';
        document.getElementById('reader').style.display = 'block';
        startHtml5Qrcode();
      }
    }

    function startHtml5Qrcode() {
      const html5QrCode = new Html5Qrcode("reader");
      Html5Qrcode.getCameras().then(devices => {
        if (devices && devices.length) {
          html5QrCode.start(
            devices[0].id,
            { fps: 10, qrbox: 250 },
            (decodedText) => {
              addResult(decodedText);
            }
          ).catch(err => console.error("html5-qrcode 启动失败:", err));
        }
      });
    }

    startZXing();
  </script>
</body>
</html>
