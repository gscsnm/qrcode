<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>æ‰¹é‡å›¾ä¹¦æ‰«ç ï¼ˆè®¡æ•°ç‰ˆï¼‰ - ä¿®å¤ç‰ˆ</title>

<!-- html5-qrcodeï¼ˆé¦–é€‰ï¼‰ -->
<script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
<!-- zxing ä½œä¸ºå¤‡ç”¨ï¼ˆä¿ç•™ï¼‰ -->
<script src="https://unpkg.com/@zxing/browser@latest"></script>

<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;padding:14px;color:#111}
  h1{font-size:1.05rem;margin-bottom:6px}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
  .btn{padding:8px 12px;border-radius:6px;border:1px solid #ccc;background:#f7f7f7;cursor:pointer}
  .btn.primary{background:#0b84ff;color:#fff;border-color:#0b84ff}
  #video, #reader {width:100%;max-width:480px;background:#000;margin:0 auto;border-radius:6px}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{border:1px solid #eee;padding:8px;font-size:0.9rem;text-align:left}
  .small{font-size:0.85rem;color:#666}
  .status{margin-top:8px;color:#0b84ff}
  .err{color:#c00}
</style>
</head>
<body>
  <h1>ğŸ“š æ‰¹é‡æ‰«ç å¹¶è®¡æ•°ï¼ˆä¿®å¤ç‰ˆï¼‰</h1>
  <div class="small">è¯´æ˜ï¼šè¯·ç¡®ä¿é¡µé¢é€šè¿‡ HTTPS è®¿é—®ï¼ˆGitHub Pages / Netlifyï¼‰ï¼Œå¹¶å…è®¸æµè§ˆå™¨ä½¿ç”¨ç›¸æœºæƒé™ã€‚</div>

  <div class="controls">
    <button id="startBtn" class="btn primary">å¼€å§‹æ‰«ç </button>
    <button id="stopBtn" class="btn">åœæ­¢æ‰«ç </button>
    <button id="undoBtn" class="btn">æ’¤é”€ä¸Šä¸€æ¬¡</button>
    <button id="clearBtn" class="btn">æ¸…ç©ºå…¨éƒ¨</button>
    <label style="display:flex;align-items:center;gap:6px"><input id="dupAllow" type="checkbox" checked> å…è®¸å¿«é€Ÿé‡å¤è®¡æ•°</label>
    <label style="display:flex;align-items:center;gap:6px"><input id="autoFetch" type="checkbox" checked> è‡ªåŠ¨æŠ“ OpenLibrary ä¿¡æ¯</label>
  </div>

  <div style="max-width:480px;margin:0 auto">
    <!-- html5-qrcode å®¹å™¨ï¼ˆé¦–é€‰ï¼‰ -->
    <div id="reader" style="width:100%;"></div>
    <!-- å¤‡ç”¨ï¼šzxing è§†é¢‘å…ƒç´ ï¼ˆä»…åœ¨ zxing å¯åŠ¨æ—¶ä½¿ç”¨ï¼‰ -->
    <video id="video" autoplay playsinline style="display:none;width:100%;"></video>
  </div>

  <div class="status" id="status">çŠ¶æ€ï¼šç©ºé—²</div>
  <div id="error" class="err"></div>

  <div style="margin-top:12px;max-width:680px">
    <div style="display:flex;gap:8px">
      <input id="manualInput" placeholder="æ‰‹åŠ¨æ¡ç æˆ– ISBNï¼Œå›è½¦æ·»åŠ " style="flex:1;padding:8px"/>
      <button id="manualAdd" class="btn">æ·»åŠ </button>
    </div>
    <div class="small" style="margin-top:6px">è¯¯è§¦å¯ç”¨æ’¤é”€/å‡è®¡æ•°/åˆ é™¤æ“ä½œã€‚</div>
  </div>

  <table id="tb" style="margin-top:14px;max-width:960px">
    <thead><tr><th>#</th><th>æ¡ç </th><th>æ•°é‡</th><th>é¦–æ¬¡æ‰«æ</th><th>æœ€è¿‘æ‰«æ</th><th>æ“ä½œ</th></tr></thead>
    <tbody></tbody>
  </table>

  <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
    <button id="exportCsv" class="btn">å¯¼å‡ºæ±‡æ€» CSV</button>
    <button id="exportEvents" class="btn">å¯¼å‡ºäº‹ä»¶ CSVï¼ˆæ¯æ¬¡æ‰«ç ï¼‰</button>
    <button id="downloadTxt" class="btn">ä¸‹è½½æ¡ç  TXTï¼ˆbarcode,countï¼‰</button>
  </div>

<script>
/* æ•°æ®å­˜å‚¨ */
const counts = new Map();
const events = [];
const lastScanAt = new Map();
const DEBOUNCE_MS = 700;

let allowQuickDup = true;
let scanning = false;
let html5Qr = null;
let zxingReader = null;

const statusEl = document.getElementById('status');
const errorEl = document.getElementById('error');
const readerDiv = document.getElementById('reader');
const videoElem = document.getElementById('video');
const tbody = document.querySelector('#tb tbody');

document.getElementById('startBtn').addEventListener('click', startScanner);
document.getElementById('stopBtn').addEventListener('click', stopScanner);
document.getElementById('undoBtn').addEventListener('click', undoLast);
document.getElementById('clearBtn').addEventListener('click', clearAll);
document.getElementById('manualAdd').addEventListener('click', ()=>{ const v=document.getElementById('manualInput').value.trim(); if(v){ handleScanned(v); document.getElementById('manualInput').value=''; }});
document.getElementById('manualInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ document.getElementById('manualAdd').click(); }});
document.getElementById('exportCsv').addEventListener('click', downloadSummaryCSV);
document.getElementById('exportEvents').addEventListener('click', downloadEventsCSV);
document.getElementById('downloadTxt').addEventListener('click', downloadTxtFile);
document.getElementById('dupAllow').addEventListener('change', (e)=>{ allowQuickDup = e.target.checked; });

function setStatus(s){ statusEl.textContent = 'çŠ¶æ€ï¼š' + s; errorEl.textContent=''; }
function setError(e){ errorEl.textContent = 'é”™è¯¯ï¼š' + e; statusEl.textContent = 'çŠ¶æ€ï¼šé”™è¯¯'; }

function nowISO(){ return new Date().toISOString(); }

function handleScanned(raw){
  const code = String(raw).replace(/\s+/g,'');
  const t = Date.now();
  if(!allowQuickDup){
    const last = lastScanAt.get(code) || 0;
    if(t - last < DEBOUNCE_MS) return;
  }
  lastScanAt.set(code, t);

  const rec = counts.get(code);
  if(rec){
    rec.count += 1;
    rec.last = nowISO();
  } else {
    counts.set(code, { count: 1, first: nowISO(), last: nowISO() });
  }
  events.push({ barcode: code, time: nowISO() });
  renderTable();

  // optional auto fetch info (non-blocking)
  if(document.getElementById('autoFetch').checked){
    const isIsbn = /^\d{10}$|^\d{13}$/.test(code.replace(/[^0-9Xx]/g,''));
    if(isIsbn){
      fetch(`https://openlibrary.org/api/books?bibkeys=ISBN:${code}&format=json&jscmd=data`)
        .then(r=>r.json())
        .then(js=>{
          const key = `ISBN:${code}`;
          if(js && js[key]){
            const info = js[key];
            const rec2 = counts.get(code);
            if(rec2){ rec2.title = info.title || ''; rec2.authors = (info.authors||[]).map(a=>a.name).join(', '); renderTable(); }
          }
        }).catch(()=>{ /* ignore */ });
    }
  }
}

function renderTable(){
  tbody.innerHTML = '';
  let i=0;
  for(const [barcode, rec] of counts.entries()){
    i++;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${i}</td>
      <td>${escapeHtml(barcode)}</td>
      <td>
        <button data-action="dec" data-code="${barcode}" class="btn">-</button>
        <span style="margin:0 8px">${rec.count}</span>
        <button data-action="inc" data-code="${barcode}" class="btn">+</button>
      </td>
      <td>${rec.first||''}</td>
      <td>${rec.last||''}${rec.title?'<div class="small">ã€Š'+escapeHtml(rec.title)+'ã€‹</div>':''}</td>
      <td><button data-action="remove" data-code="${barcode}" class="btn">åˆ é™¤</button></td>
    `;
    tbody.appendChild(tr);
  }
  tbody.querySelectorAll('button[data-action]').forEach(b=>{
    b.onclick = ()=> {
      const a = b.dataset.action, c = b.dataset.code;
      if(a==='inc'){ changeCount(c,1); }
      else if(a==='dec'){ changeCount(c,-1); }
      else if(a==='remove'){ counts.delete(c); renderTable(); }
    };
  });
}

function changeCount(code,delta){
  const rec = counts.get(code);
  if(!rec) return;
  rec.count += delta;
  if(rec.count <= 0) counts.delete(code);
  else rec.last = nowISO();
  if(delta>0) events.push({barcode: code, time: nowISO()});
  renderTable();
}

function undoLast(){
  const ev = events.pop();
  if(!ev){ alert('æ²¡æœ‰å¯æ’¤é”€çš„æ‰«ç '); return; }
  const rec = counts.get(ev.barcode);
  if(rec){
    rec.count -= 1;
    if(rec.count <= 0) counts.delete(ev.barcode);
    else rec.last = nowISO();
  }
  renderTable();
}

function clearAll(){
  if(!confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰è®°å½•å—ï¼Ÿ')) return;
  counts.clear(); events.length = 0; renderTable();
}

/* å¯¼å‡º */
function downloadSummaryCSV(){
  const header = ['barcode','count','first_seen','last_seen'];
  let csv = header.join(',') + '\\n';
  for(const [b, r] of counts.entries()){
    csv += [b, r.count, r.first||'', r.last||''].map(csvEscape).join(',') + '\\n';
  }
  downloadBlob(csv, `books_summary_${(new Date()).toISOString().slice(0,10)}.csv`, 'text/csv;charset=utf-8;');
}
function downloadEventsCSV(){
  const header = ['barcode','time'];
  let csv = header.join(',') + '\\n';
  events.forEach(e=>{ csv += [e.barcode, e.time].map(csvEscape).join(',') + '\\n'; });
  downloadBlob(csv, `books_events_${(new Date()).toISOString().slice(0,10)}.csv`, 'text/csv;charset=utf-8;');
}
function downloadTxtFile(){
  let txt = '';
  for(const [b, r] of counts.entries()) txt += `${b},${r.count}\\n`;
  downloadBlob(txt, `books_${(new Date()).toISOString().slice(0,10)}.txt`, 'text/plain');
}
function csvEscape(v){ if(v==null) return '""'; const s = String(v).replaceAll('"','""'); return `"${s}"`; }
function downloadBlob(content, filename, type){
  const blob = new Blob([content], { type }); const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}
function escapeHtml(s){ if(!s) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('\"','&quot;'); }

/* å¯åŠ¨æ‰«æï¼šä¼˜å…ˆ html5-qrcodeï¼›å¤±è´¥åˆ™å°è¯• zxing */
async function startScanner(){
  if(scanning){ setStatus('å·²åœ¨æ‰«æä¸­'); return; }
  setError('');
  setStatus('å°è¯•å¯åŠ¨æ‘„åƒå¤´ï¼ˆhtml5-qrcode é¦–é€‰ï¼‰...');
  // html5-qrcode å¯åŠ¨æµç¨‹
  try {
    if(typeof Html5Qrcode === 'undefined') throw new Error('Html5Qrcode æœªåŠ è½½');
    html5Qr = new Html5Qrcode("reader");
    const cams = await Html5Qrcode.getCameras();
    if(!cams || cams.length===0) throw new Error('æœªæ‰¾åˆ°æ‘„åƒå¤´è®¾å¤‡');
    // ä¼˜å…ˆé€‰åç½®ï¼ˆå¦‚æœ label å­˜åœ¨ 'back'/'rear'ï¼‰
    let camId = cams[0].id;
    for(const c of cams){
      const lab = (c.label||'').toLowerCase();
      if(lab.includes('back') || lab.includes('rear') || lab.includes('åç½®')){ camId = c.id; break; }
    }
    await html5Qr.start(camId, { fps: 10, qrbox: 250 },
      (decodedText) => { handleScanned(decodedText); },
      (err) => { /* ignore frame errors */ }
    );
    scanning = true;
    setStatus('ä½¿ç”¨ html5-qrcode æ‰«æä¸­');
    return;
  } catch(e){
    console.warn('html5-qrcode å¯åŠ¨å¤±è´¥ï¼š', e);
    setStatus('html5-qrcode å¯åŠ¨å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨ ZXing...');
  }

  // å¤‡ç”¨ ZXingï¼ˆå¦‚æœåŠ è½½ä¸”å¯ç”¨ï¼‰
  try {
    const ZX = window.ZXing || window.ZXingBrowser || window.ZXingJs || null;
    if(!ZX || !ZX.BrowserMultiFormatReader) {
      // try import namespace from '@zxing/browser' global
      if(window.ZXing && window.ZXing.BrowserMultiFormatReader) { /* ok */ }
      else if(window.ZXingBrowser && window.ZXingBrowser.BrowserMultiFormatReader) { /* ok */ }
      else throw new Error('ZXing åº“ä¸å¯ç”¨');
    }
    // ä½¿ç”¨ @zxing/browser çš„æ ‡å‡†å®ä¾‹
    const codeReader = new (window.ZXing?.BrowserMultiFormatReader || window.ZXingBrowser?.BrowserMultiFormatReader || window.ZXing?.BrowserCodeReader)();
    zxingReader = codeReader;
    // è·å–è®¾å¤‡åˆ—è¡¨
    const devices = await (window.ZXing?.BrowserCodeReader?.listVideoInputDevices?.() || window.ZXingBrowser?.BrowserCodeReader?.listVideoInputDevices?.() || codeReader.listVideoInputDevices?.());
    let deviceId = devices && devices.length ? devices[devices.length-1].deviceId : undefined;
    // æ˜¾ç¤ºè§†é¢‘å…ƒç´  for zxing
    videoElem.style.display = '';
    // decodeFromVideoDevice æ¥å£
    codeReader.decodeFromVideoDevice(deviceId, 'video', (result, err) => {
      if(result && result.getText) handleScanned(result.getText());
    });
    scanning = true;
    setStatus('ä½¿ç”¨ ZXing æ‰«æä¸­');
    return;
  } catch(e2){
    console.error('ZXing å¯åŠ¨å¤±è´¥ï¼š', e2);
    setError('æ‘„åƒå¤´åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·ç¡®è®¤é¡µé¢ä¸º HTTPS å¹¶å…è®¸æ‘„åƒå¤´æƒé™ï¼›æˆ–å°è¯•åœ¨å¦ä¸€å°è®¾å¤‡/æµè§ˆå™¨æ‰“å¼€ã€‚å…·ä½“é”™è¯¯ï¼š' + (e2 && e2.message ? e2.message : e2));
    scanning = false;
    return;
  }
}

function stopScanner(){
  if(html5Qr){
    html5Qr.stop().catch(()=>{}); html5Qr = null;
  }
  if(zxingReader){
    try{ zxingReader.reset(); }catch(e){} zxingReader = null;
  }
  // éšè— video / æ¢å¤ reader æ˜¾ç¤ºæ§åˆ¶ï¼ˆhtml5 reader æ˜¾ç¤ºåœ¨ reader å…ƒç´ ï¼‰
  videoElem.style.display = 'none';
  setStatus('å·²åœæ­¢');
  scanning = false;
}

// åœ¨é¡µé¢å…³é—­æ—¶åœæ­¢
window.addEventListener('beforeunload', ()=>{ try{ stopScanner(); }catch(e){} });

</script>
</body>
</html>
