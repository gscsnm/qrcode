<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>å›¾ä¹¦æ¡ç æ‰«æå™¨ (ZXing + html5-qrcode Fallback)</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin: 20px; }
    #video { width: 100%; max-width: 400px; }
    #reader { width: 100%; max-width: 400px; margin: auto; display: none; }
    #output { margin-top: 20px; font-size: 18px; }
    #fallback { color: red; margin-top: 15px; }
  </style>
</head>
<body>
  <h2>ğŸ“š å›¾ä¹¦æ¡ç æ‰«æå™¨</h2>
  <p>é»˜è®¤ä½¿ç”¨ ZXingï¼Œå¦‚æœå¤±è´¥åˆ™è‡ªåŠ¨åˆ‡æ¢åˆ° html5-qrcodeã€‚</p>

  <!-- ZXing è§†é¢‘é¢„è§ˆ -->
  <video id="video" autoplay></video>

  <!-- html5-qrcode å®¹å™¨ -->
  <div id="reader"></div>

  <div id="output">æ‰«æç»“æœ: <span id="result">æ— </span></div>
  <div id="fallback"></div>

  <!-- ZXing -->
  <script src="https://unpkg.com/@zxing/library@latest"></script>
  <!-- html5-qrcode -->
  <script src="https://unpkg.com/html5-qrcode"></script>

  <script>
    const resultSpan = document.getElementById("result");
    const videoElem = document.getElementById("video");
    const readerElem = document.getElementById("reader");
    const fallbackMsg = document.getElementById("fallback");

    function startZXing() {
      try {
        const codeReader = new ZXing.BrowserBarcodeReader();
        codeReader.decodeFromVideoDevice(null, "video", (result, err) => {
          if (result) {
            resultSpan.textContent = result.getText();
          }
        }).catch((err) => {
          console.error("ZXing åˆå§‹åŒ–å¤±è´¥ï¼Œåˆ‡æ¢ fallback:", err);
          startHtml5Qrcode();
        });
      } catch (e) {
        console.error("ZXing å¼‚å¸¸:", e);
        startHtml5Qrcode();
      }
    }

    function startHtml5Qrcode() {
      videoElem.style.display = "none";  // éšè— zxing è§†é¢‘
      readerElem.style.display = "block";
      fallbackMsg.textContent = "âš ï¸ ZXing å¤±è´¥ï¼Œå·²åˆ‡æ¢åˆ° html5-qrcode";

      const html5QrCode = new Html5Qrcode("reader");
      Html5Qrcode.getCameras().then(devices => {
        if (devices && devices.length) {
          const cameraId = devices[0].id;
          html5QrCode.start(
            cameraId,
            { fps: 10, qrbox: 250 },
            (decodedText) => {
              resultSpan.textContent = decodedText;
            },
            (errorMessage) => {
              // è¿™é‡Œå¯ä»¥å¿½ç•¥é”™è¯¯æ—¥å¿—
            }
          ).catch(err => {
            console.error("html5-qrcode å¯åŠ¨å¤±è´¥:", err);
            fallbackMsg.textContent = "âŒ ZXing å’Œ html5-qrcode éƒ½æ— æ³•å·¥ä½œ";
          });
        }
      }).catch(err => {
        console.error("è·å–æ‘„åƒå¤´å¤±è´¥:", err);
        fallbackMsg.textContent = "âŒ æ— æ³•è®¿é—®æ‘„åƒå¤´";
      });
    }

    // å¯åŠ¨
    window.addEventListener("load", startZXing);
  </script>
</body>
</html>
