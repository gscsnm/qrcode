<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>批量图书扫码（计数版） - 修复版</title>

<!-- html5-qrcode（首选） -->
<script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
<!-- zxing 作为备用（保留） -->
<script src="https://unpkg.com/@zxing/browser@latest"></script>

<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;padding:14px;color:#111}
  h1{font-size:1.05rem;margin-bottom:6px}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
  .btn{padding:8px 12px;border-radius:6px;border:1px solid #ccc;background:#f7f7f7;cursor:pointer}
  .btn.primary{background:#0b84ff;color:#fff;border-color:#0b84ff}
  #video, #reader {width:100%;max-width:480px;background:#000;margin:0 auto;border-radius:6px}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{border:1px solid #eee;padding:8px;font-size:0.9rem;text-align:left}
  .small{font-size:0.85rem;color:#666}
  .status{margin-top:8px;color:#0b84ff}
  .err{color:#c00}
</style>
</head>
<body>
  <h1>📚 批量扫码并计数（修复版）</h1>
  <div class="small">说明：请确保页面通过 HTTPS 访问（GitHub Pages / Netlify），并允许浏览器使用相机权限。</div>

  <div class="controls">
    <button id="startBtn" class="btn primary">开始扫码</button>
    <button id="stopBtn" class="btn">停止扫码</button>
    <button id="undoBtn" class="btn">撤销上一次</button>
    <button id="clearBtn" class="btn">清空全部</button>
    <label style="display:flex;align-items:center;gap:6px"><input id="dupAllow" type="checkbox" checked> 允许快速重复计数</label>
    <label style="display:flex;align-items:center;gap:6px"><input id="autoFetch" type="checkbox" checked> 自动抓 OpenLibrary 信息</label>
  </div>

  <div style="max-width:480px;margin:0 auto">
    <!-- html5-qrcode 容器（首选） -->
    <div id="reader" style="width:100%;"></div>
    <!-- 备用：zxing 视频元素（仅在 zxing 启动时使用） -->
    <video id="video" autoplay playsinline style="display:none;width:100%;"></video>
  </div>

  <div class="status" id="status">状态：空闲</div>
  <div id="error" class="err"></div>

  <div style="margin-top:12px;max-width:680px">
    <div style="display:flex;gap:8px">
      <input id="manualInput" placeholder="手动条码或 ISBN，回车添加" style="flex:1;padding:8px"/>
      <button id="manualAdd" class="btn">添加</button>
    </div>
    <div class="small" style="margin-top:6px">误触可用撤销/减计数/删除操作。</div>
  </div>

  <table id="tb" style="margin-top:14px;max-width:960px">
    <thead><tr><th>#</th><th>条码</th><th>数量</th><th>首次扫描</th><th>最近扫描</th><th>操作</th></tr></thead>
    <tbody></tbody>
  </table>

  <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
    <button id="exportCsv" class="btn">导出汇总 CSV</button>
    <button id="exportEvents" class="btn">导出事件 CSV（每次扫码）</button>
    <button id="downloadTxt" class="btn">下载条码 TXT（barcode,count）</button>
  </div>

<script>
/* 数据存储 */
const counts = new Map();
const events = [];
const lastScanAt = new Map();
const DEBOUNCE_MS = 700;

let allowQuickDup = true;
let scanning = false;
let html5Qr = null;
let zxingReader = null;

const statusEl = document.getElementById('status');
const errorEl = document.getElementById('error');
const readerDiv = document.getElementById('reader');
const videoElem = document.getElementById('video');
const tbody = document.querySelector('#tb tbody');

document.getElementById('startBtn').addEventListener('click', startScanner);
document.getElementById('stopBtn').addEventListener('click', stopScanner);
document.getElementById('undoBtn').addEventListener('click', undoLast);
document.getElementById('clearBtn').addEventListener('click', clearAll);
document.getElementById('manualAdd').addEventListener('click', ()=>{ const v=document.getElementById('manualInput').value.trim(); if(v){ handleScanned(v); document.getElementById('manualInput').value=''; }});
document.getElementById('manualInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ document.getElementById('manualAdd').click(); }});
document.getElementById('exportCsv').addEventListener('click', downloadSummaryCSV);
document.getElementById('exportEvents').addEventListener('click', downloadEventsCSV);
document.getElementById('downloadTxt').addEventListener('click', downloadTxtFile);
document.getElementById('dupAllow').addEventListener('change', (e)=>{ allowQuickDup = e.target.checked; });

function setStatus(s){ statusEl.textContent = '状态：' + s; errorEl.textContent=''; }
function setError(e){ errorEl.textContent = '错误：' + e; statusEl.textContent = '状态：错误'; }

function nowISO(){ return new Date().toISOString(); }

function handleScanned(raw){
  const code = String(raw).replace(/\s+/g,'');
  const t = Date.now();
  if(!allowQuickDup){
    const last = lastScanAt.get(code) || 0;
    if(t - last < DEBOUNCE_MS) return;
  }
  lastScanAt.set(code, t);

  const rec = counts.get(code);
  if(rec){
    rec.count += 1;
    rec.last = nowISO();
  } else {
    counts.set(code, { count: 1, first: nowISO(), last: nowISO() });
  }
  events.push({ barcode: code, time: nowISO() });
  renderTable();

  // optional auto fetch info (non-blocking)
  if(document.getElementById('autoFetch').checked){
    const isIsbn = /^\d{10}$|^\d{13}$/.test(code.replace(/[^0-9Xx]/g,''));
    if(isIsbn){
      fetch(`https://openlibrary.org/api/books?bibkeys=ISBN:${code}&format=json&jscmd=data`)
        .then(r=>r.json())
        .then(js=>{
          const key = `ISBN:${code}`;
          if(js && js[key]){
            const info = js[key];
            const rec2 = counts.get(code);
            if(rec2){ rec2.title = info.title || ''; rec2.authors = (info.authors||[]).map(a=>a.name).join(', '); renderTable(); }
          }
        }).catch(()=>{ /* ignore */ });
    }
  }
}

function renderTable(){
  tbody.innerHTML = '';
  let i=0;
  for(const [barcode, rec] of counts.entries()){
    i++;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${i}</td>
      <td>${escapeHtml(barcode)}</td>
      <td>
        <button data-action="dec" data-code="${barcode}" class="btn">-</button>
        <span style="margin:0 8px">${rec.count}</span>
        <button data-action="inc" data-code="${barcode}" class="btn">+</button>
      </td>
      <td>${rec.first||''}</td>
      <td>${rec.last||''}${rec.title?'<div class="small">《'+escapeHtml(rec.title)+'》</div>':''}</td>
      <td><button data-action="remove" data-code="${barcode}" class="btn">删除</button></td>
    `;
    tbody.appendChild(tr);
  }
  tbody.querySelectorAll('button[data-action]').forEach(b=>{
    b.onclick = ()=> {
      const a = b.dataset.action, c = b.dataset.code;
      if(a==='inc'){ changeCount(c,1); }
      else if(a==='dec'){ changeCount(c,-1); }
      else if(a==='remove'){ counts.delete(c); renderTable(); }
    };
  });
}

function changeCount(code,delta){
  const rec = counts.get(code);
  if(!rec) return;
  rec.count += delta;
  if(rec.count <= 0) counts.delete(code);
  else rec.last = nowISO();
  if(delta>0) events.push({barcode: code, time: nowISO()});
  renderTable();
}

function undoLast(){
  const ev = events.pop();
  if(!ev){ alert('没有可撤销的扫码'); return; }
  const rec = counts.get(ev.barcode);
  if(rec){
    rec.count -= 1;
    if(rec.count <= 0) counts.delete(ev.barcode);
    else rec.last = nowISO();
  }
  renderTable();
}

function clearAll(){
  if(!confirm('确定清空所有记录吗？')) return;
  counts.clear(); events.length = 0; renderTable();
}

/* 导出 */
function downloadSummaryCSV(){
  const header = ['barcode','count','first_seen','last_seen'];
  let csv = header.join(',') + '\\n';
  for(const [b, r] of counts.entries()){
    csv += [b, r.count, r.first||'', r.last||''].map(csvEscape).join(',') + '\\n';
  }
  downloadBlob(csv, `books_summary_${(new Date()).toISOString().slice(0,10)}.csv`, 'text/csv;charset=utf-8;');
}
function downloadEventsCSV(){
  const header = ['barcode','time'];
  let csv = header.join(',') + '\\n';
  events.forEach(e=>{ csv += [e.barcode, e.time].map(csvEscape).join(',') + '\\n'; });
  downloadBlob(csv, `books_events_${(new Date()).toISOString().slice(0,10)}.csv`, 'text/csv;charset=utf-8;');
}
function downloadTxtFile(){
  let txt = '';
  for(const [b, r] of counts.entries()) txt += `${b},${r.count}\\n`;
  downloadBlob(txt, `books_${(new Date()).toISOString().slice(0,10)}.txt`, 'text/plain');
}
function csvEscape(v){ if(v==null) return '""'; const s = String(v).replaceAll('"','""'); return `"${s}"`; }
function downloadBlob(content, filename, type){
  const blob = new Blob([content], { type }); const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}
function escapeHtml(s){ if(!s) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('\"','&quot;'); }

/* 启动扫描：优先 html5-qrcode；失败则尝试 zxing */
async function startScanner(){
  if(scanning){ setStatus('已在扫描中'); return; }
  setError('');
  setStatus('尝试启动摄像头（html5-qrcode 首选）...');
  // html5-qrcode 启动流程
  try {
    if(typeof Html5Qrcode === 'undefined') throw new Error('Html5Qrcode 未加载');
    html5Qr = new Html5Qrcode("reader");
    const cams = await Html5Qrcode.getCameras();
    if(!cams || cams.length===0) throw new Error('未找到摄像头设备');
    // 优先选后置（如果 label 存在 'back'/'rear'）
    let camId = cams[0].id;
    for(const c of cams){
      const lab = (c.label||'').toLowerCase();
      if(lab.includes('back') || lab.includes('rear') || lab.includes('后置')){ camId = c.id; break; }
    }
    await html5Qr.start(camId, { fps: 10, qrbox: 250 },
      (decodedText) => { handleScanned(decodedText); },
      (err) => { /* ignore frame errors */ }
    );
    scanning = true;
    setStatus('使用 html5-qrcode 扫描中');
    return;
  } catch(e){
    console.warn('html5-qrcode 启动失败：', e);
    setStatus('html5-qrcode 启动失败，尝试备用 ZXing...');
  }

  // 备用 ZXing（如果加载且可用）
  try {
    const ZX = window.ZXing || window.ZXingBrowser || window.ZXingJs || null;
    if(!ZX || !ZX.BrowserMultiFormatReader) {
      // try import namespace from '@zxing/browser' global
      if(window.ZXing && window.ZXing.BrowserMultiFormatReader) { /* ok */ }
      else if(window.ZXingBrowser && window.ZXingBrowser.BrowserMultiFormatReader) { /* ok */ }
      else throw new Error('ZXing 库不可用');
    }
    // 使用 @zxing/browser 的标准实例
    const codeReader = new (window.ZXing?.BrowserMultiFormatReader || window.ZXingBrowser?.BrowserMultiFormatReader || window.ZXing?.BrowserCodeReader)();
    zxingReader = codeReader;
    // 获取设备列表
    const devices = await (window.ZXing?.BrowserCodeReader?.listVideoInputDevices?.() || window.ZXingBrowser?.BrowserCodeReader?.listVideoInputDevices?.() || codeReader.listVideoInputDevices?.());
    let deviceId = devices && devices.length ? devices[devices.length-1].deviceId : undefined;
    // 显示视频元素 for zxing
    videoElem.style.display = '';
    // decodeFromVideoDevice 接口
    codeReader.decodeFromVideoDevice(deviceId, 'video', (result, err) => {
      if(result && result.getText) handleScanned(result.getText());
    });
    scanning = true;
    setStatus('使用 ZXing 扫描中');
    return;
  } catch(e2){
    console.error('ZXing 启动失败：', e2);
    setError('摄像头初始化失败，请确认页面为 HTTPS 并允许摄像头权限；或尝试在另一台设备/浏览器打开。具体错误：' + (e2 && e2.message ? e2.message : e2));
    scanning = false;
    return;
  }
}

function stopScanner(){
  if(html5Qr){
    html5Qr.stop().catch(()=>{}); html5Qr = null;
  }
  if(zxingReader){
    try{ zxingReader.reset(); }catch(e){} zxingReader = null;
  }
  // 隐藏 video / 恢复 reader 显示控制（html5 reader 显示在 reader 元素）
  videoElem.style.display = 'none';
  setStatus('已停止');
  scanning = false;
}

// 在页面关闭时停止
window.addEventListener('beforeunload', ()=>{ try{ stopScanner(); }catch(e){} });

</script>
</body>
</html>
